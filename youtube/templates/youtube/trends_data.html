{% extends "base.html" %}
{% load static %}

{% block content %}
<h2>YouTube Channel Trends</h2>

<div>
    <label for="dateFrom">From:</label>
    <input type="date" id="dateFrom" value="{{ default_date_from }}">
    <label for="dateTo">To:</label>
    <input type="date" id="dateTo" value="{{ default_date_to }}">
    <button id="updateBtn">Update</button>
</div>

<div>
    <canvas id="trendsChart" width="800" height="400"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const ctx = document.getElementById('trendsChart').getContext('2d');

    let trendsChart;

    function renderChart(dates, stats) {
        const viewsData = stats.map(s => s.views);
        const subscribersData = stats.map(s => s.subscribers);
        const videoCountData = stats.map(s => s.video_count);

        if (trendsChart) {
            trendsChart.destroy();
        }

        trendsChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: dates,
                datasets: [
                    {
                        label: 'Views',
                        data: viewsData,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        fill: false,
                        tension: 0.1
                    },
                    {
                        label: 'Subscribers',
                        data: subscribersData,
                        borderColor: 'rgba(153, 102, 255, 1)',
                        backgroundColor: 'rgba(153, 102, 255, 0.2)',
                        fill: false,
                        tension: 0.1
                    },
                    {
                        label: 'Videos',
                        data: videoCountData,
                        borderColor: 'rgba(255, 159, 64, 1)',
                        backgroundColor: 'rgba(255, 159, 64, 0.2)',
                        fill: false,
                        tension: 0.1
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'top' },
                    title: { display: true, text: 'Channel Trends' }
                },
                scales: {
                    x: { title: { display: true, text: 'Date' } },
                    y: { beginAtZero: true }
                }
            }
        });
    }

    async function fetchTrends() {
        const dateFrom = document.getElementById('dateFrom').value;
        const dateTo = document.getElementById('dateTo').value;

        try {
            const response = await fetch(`/api/youtube/trends/data/?date_from=${dateFrom}&date_to=${dateTo}`, {
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });
            if (!response.ok) throw new Error('Failed to fetch trends');
            const data = await response.json();
            renderChart(data.dates, data.stats);
        } catch (error) {
            alert(error.message);
        }
    }

    document.getElementById('updateBtn').addEventListener('click', fetchTrends);

    renderChart({{ dates_json|safe }}, {{ stats_json|safe }});
</script>
{% endblock %}
