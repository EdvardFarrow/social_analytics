{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>YouTube Analytics Dashboard</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'youtube/css/dashboard.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <h1>YouTube Dashboard</h1>
        
        <p id="loading-message">Загрузка данных...</p>

        <div class="date-filter-container">
            <label for="startDate">С:</label>
            <input type="date" id="startDate" name="startDate">
            <label for="endDate">По:</label>
            <input type="date" id="endDate" name="endDate">
            <button id="applyFilterBtn">Применить</button>
        </div>

        <div class="main-charts">
            <div class="chart-container">
                <h2>Динамика просмотров канала</h2>
                <p class="data-info">Данные обновляются с задержкой 2-3 дня.</p>
                <canvas id="viewsChart"></canvas>
            </div>
            
            <div class="chart-container">
                <h2>Динамика подписчиков</h2>
                <p class="data-info">Данные обновляются с задержкой 2-3 дня.</p>
                <canvas id="subscribersChart"></canvas>
            </div>
        </div>

        <div class="demographics-section">
            <h2>Демография аудитории</h2>
            <p id="demographics-message" style="text-align: center; color: #888; display: none;">Данных недостаточно для отображения графиков.</p>
            <div class="demographics-charts-row">
                <div class="chart-container-large">
                    <h3>Возрастные группы</h3>
                    <canvas id="ageChart"></canvas>
                </div>
                <div class="chart-container-small">
                    <h3>Пол</h3>
                    <canvas id="genderChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-12 text-center">
                <p id="viewer-activity-message" style="display: none;">Недостаточно данных для построения графиков активности аудитории.</p>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        Просмотры по типу устройства
                    </div>
                    <div class="card-body">
                        <canvas id="deviceTypeChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        Просмотры по статусу подписки
                    </div>
                    <div class="card-body">
                        <canvas id="subscribedStatusChart"></canvas>
                    </div>
                </div>
            </div>
        </div>


        <div id="gemini-chat-container" data-dashboard='{{ dashboard_data_json|escapejs }}'>            
            <div id="gemini-chat-header">
                <span>Gemini Chat</span>
                <button id="gemini-toggle">—</button>
            </div>
            <div id="gemini-chat-messages">
                <div id="typing-indicator" style="display:none;">Gemini печатает...</div>
            </div>
            <div id="gemini-chat-input">
                <input type="text" id="gemini-input" placeholder="Напиши сообщение..." />
                <button id="gemini-send">Отправить</button>
            </div>
        </div>


        <div class="videos-section">
            <h2>Последние видео</h2>
            <table id="videosTable">
                <thead>
                    <tr>
                        <th>Название</th>
                        <th>Опубликовано</th>
                        <th>Просмотры</th>
                        <th>Лайки</th>
                        <th>Комментарии</th>
                    </tr>
                </thead>
                <tbody id="videosTableBody"></tbody>
            </table>
        </div>
    </div>
    
    <script>
        window.youtubeAccessToken = "{{ youtube_access_token }}";
        window.channelTrendsUrl = "{% url 'channel_trends' %}";
        window.videoTrendsUrl = "{% url 'video_trends' %}";
        window.audienceDemographicsUrl = "{% url 'audience_demographics' %}";
        window.channelId = "{{ channel_id }}"; 
        window.viewerActivityData = {{ viewer_activity_data|safe }};

        window.dashboardData = {{ dashboard_data_json|safe }};
        window.geminiChatContainer = document.getElementById('gemini-chat-container');
        window.geminiChatMessages = document.getElementById('gemini-chat-messages');
        window.geminiInput = document.getElementById('gemini-input');
        window.geminiSendBtn = document.getElementById('gemini-send');
        window.toggleBtn = document.getElementById('gemini-toggle'); 

    </script>
    {% load static %}
    <script src="{% static 'youtube/js/dashboard.js' %}"></script>
</body>
</html>