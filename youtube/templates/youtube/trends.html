{% extends 'youtube/base.html' %}

{% block title %}YouTube Channel Trends{% endblock %}

{% block content %}
<h1>Channel Trends</h1>

<form id="filterForm" style="margin-bottom: 20px;">
  <label for="channel_id">Channel ID:</label>
  <input type="text" id="channel_id" name="channel_id" value="{{ default_channel_id|default:'' }}" required style="width: 300px;">

  <label for="date_from">From:</label>
  <input type="date" id="date_from" name="date_from" value="{{ default_date_from|default:'' }}">

  <label for="date_to">To:</label>
  <input type="date" id="date_to" name="date_to" value="{{ default_date_to|default:'' }}">

  <button type="submit">Load Trends</button>
</form>

<canvas id="trendsChart" width="800" height="400" style="background: #fff; border: 1px solid #ccc; border-radius: 8px;"></canvas>

<div id="errorMessage" style="color: red; margin-top: 10px;"></div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const ctx = document.getElementById('trendsChart').getContext('2d');
  let trendsChart = null;

  async function loadTrends(event) {
    if (event) event.preventDefault();

    const errorDiv = document.getElementById('errorMessage');
    errorDiv.textContent = '';

    const form = document.getElementById('filterForm');
    const formData = new FormData(form);

    const params = new URLSearchParams(formData);

    const channelId = formData.get('channel_id');
    if (!channelId) {
      errorDiv.textContent = 'Please enter a Channel ID.';
      return;
    }

    try {
      const response = await fetch("{% url 'youtube_channel_trends' %}?" + params.toString(), {
        headers: {'X-Requested-With': 'XMLHttpRequest'}
      });

      if (!response.ok) {
        const errData = await response.json();
        throw new Error(errData.error || 'Failed to load data');
      }

      const data = await response.json();

      if (!data.dates.length) {
        errorDiv.textContent = 'No data available for the selected period.';
        if (trendsChart) {
          trendsChart.destroy();
          trendsChart = null;
        }
        return;
      }

      const chartData = {
        labels: data.dates,
        datasets: [
          {
            label: 'Subscribers',
            data: data.subscribers,
            borderColor: 'rgb(255, 99, 132)',
            fill: false,
            tension: 0.1,
          },
          {
            label: 'Views',
            data: data.views,
            borderColor: 'rgb(54, 162, 235)',
            fill: false,
            tension: 0.1,
          },
          {
            label: 'Video Count',
            data: data.video_count,
            borderColor: 'rgb(75, 192, 192)',
            fill: false,
            tension: 0.1,
          }
        ]
      };

      const chartOptions = {
        responsive: true,
        interaction: {
          mode: 'index',
          intersect: false,
        },
        stacked: false,
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              precision: 0
            }
          }
        }
      };

      if (trendsChart) {
        trendsChart.data = chartData;
        trendsChart.options = chartOptions;
        trendsChart.update();
      } else {
        trendsChart = new Chart(ctx, {
          type: 'line',
          data: chartData,
          options: chartOptions
        });
      }

    } catch (error) {
      errorDiv.textContent = error.message;
      if (trendsChart) {
        trendsChart.destroy();
        trendsChart = null;
      }
    }
  }

  document.getElementById('filterForm').addEventListener('submit', loadTrends);

  window.addEventListener('DOMContentLoaded', () => {
    const defaultChannelId = document.getElementById('channel_id').value;
    if (defaultChannelId) loadTrends();
  });
</script>

{% endblock %}
